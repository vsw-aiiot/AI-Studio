<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="favicon.ico" />
  <title>{% block title %}KUCHU-AI Studio{% endblock %}</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui'],
          },
          fontSize: {
            base: '15px',
            sm: '13px',
          },
          colors: {
            primary: '#3b82f6',
            accent: '#22c55e',
            danger: '#ef4444',
            amoled: '#000000', // pure black
          }
        }
      }
    };
  </script>

  <!-- Theme detection -->
  <script>
    if (
      localStorage.getItem("theme") === "dark" ||
      (!("theme" in localStorage) && window.matchMedia("(prefers-color-scheme: dark)").matches)
    ) {
      document.documentElement.classList.add("dark");
    }
  </script>

  <style>
    body {
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .dark .shadow-sm {
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
    }
  </style>

  {% block head_extra %}{% endblock %}
  <!--script src="https://unpkg.com/lucide@latest"></script-->
  <script src="https://unpkg.com/lucide@0.271.0"></script>
</head>

<body class="bg-white dark:bg-amoled text-black dark:text-white min-h-screen flex flex-col">

  <!-- Top Navbar -->
  <header class="fixed top-0 left-0 right-0 z-40 bg-white dark:bg-amoled border-b border-gray-200 dark:border-gray-800 shadow-sm">
  <div class="flex justify-between items-center px-4 py-2">
    <!-- Left Section -->
    <div class="flex items-center gap-4">
      <button onclick="toggleSidebar()" title="Toggle Sidebar" aria-label="Toggle Sidebar"
              class="bg-gray-200 dark:bg-gray-700 text-black dark:text-white px-2 py-1 rounded"><i data-lucide="menu" class="w-5 h-5"></i></button>
      <span class="text-xl font-semibold whitespace-nowrap">KUCHU-AI Studio</span>

      <select class="bg-gray-100 dark:bg-gray-700 text-black dark:text-white px-2 py-1 rounded shadow">
        <option>Default Workspace</option>
        <option>Project 1</option>
        <option>Project 2</option>
      </select>
    </div>

    <!-- Right Section -->
    <div class="flex items-center gap-3">
      {% if request.session.get('user_id') %}
        <span class="text-sm opacity-70">Signed in</span>
        <form action="/auth/logout" method="post">
          <button class="px-3 py-1 rounded bg-red-500 text-white text-sm">Logout</button>
        </form>
      {% else %}
        <a href="/auth/login" class="text-sm px-3 py-1 rounded border hover:bg-gray-100 dark:hover:bg-gray-700">Login</a>
        <a href="/auth/register" class="text-sm px-3 py-1 rounded border hover:bg-gray-100 dark:hover:bg-gray-700">Register</a>
      {% endif %}

      <button onclick="toggleTheme()" title="Toggle Theme" aria-label="Toggle Theme"
              class="bg-gray-200 dark:bg-gray-700 text-black dark:text-white px-2 py-1 rounded shadow"><i data-lucide="sun-moon" class="w-4 h-4"></i></button>
    </div>
  </div>
</header>

  <!-- Layout -->
   <!--div class="flex flex-1 pt-14 overflow-y-auto h-[calc(100vh-56px)]"-->
  <div class="flex flex-1 pt-28 overflow-y-auto h-[calc(100vh-56px)]"></div>
  <!-- Full Sidebar -->
  <!-- Expanded Sidebar (unchanged unless you want Chat as direct link instead of dropdown) -->
<aside id="sidebar"
  class="fixed top-[56px] left-0 bottom-0 w-64 bg-gray-100 dark:bg-amoled border-r overflow-y-auto transition-transform duration-300 z-30">
  <div class="p-4 space-y-6 text-sm text-black dark:text-white">
    <h3 class="text-xs uppercase font-semibold tracking-wide text-gray-500 dark:text-gray-400 mb-2">
      Your Dashboard
    </h3>
    <!-- Direct Links -->
    <a href="/" class="flex items-center gap-2 hover:text-primary">
      <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
    </a>
    <h3 class="text-xs uppercase font-semibold tracking-wide text-gray-500 dark:text-gray-400 mb-2">
      Workspace & Projects
    </h3>
    <a href="/projects" class="flex items-center gap-2 hover:text-primary">
      <i data-lucide="flask-conical" class="w-5 h-5"></i> Projects
    </a>
    <h3 class="text-xs uppercase font-semibold tracking-wide text-gray-500 dark:text-gray-400 mb-2">
      App settings
    </h3>
    <a href="/settings" class="flex items-center gap-2 hover:text-primary">
      <i data-lucide="settings" class="w-5 h-5"></i> Settings
    </a>

    <!-- Chat Dropdown -->
     <h3 class="text-xs uppercase font-semibold tracking-wide text-gray-500 dark:text-gray-400 mb-2">
      All recent sessions
    </h3>
    <details class="group mt-2" open>
      <summary class="cursor-pointer flex items-center gap-2 hover:text-primary">
        <i data-lucide="message-square" class="w-5 h-5"></i> Conversation
      </summary>
      <div class="ml-6 mt-1 space-y-1">
        {% if conversations %}
          <details class="group mt-2">
            <summary class="cursor-pointer flex items-center gap-2 hover:text-primary">
              <i data-lucide="folder-open" class="w-4 h-4"></i> Sessions
            </summary>
            <div class="ml-4 mt-1 space-y-1">
              {% for convo in conversations %}
                <div class="group flex flex-col gap-1 p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700">
                  <!-- Session Link + Rename -->
                  <div class="flex items-center gap-2">
                    <a href="/chat/conversation/{{ convo.id }}"
                      class="text-sm font-medium text-primary hover:underline flex-1 truncate">
                      üìù {{ convo.name }}
                    </a>
                    <button title="Rename Session" class="rename-btn text-xs text-gray-500 hover:text-primary">‚úèÔ∏è</button>
                  </div>

                  <!-- Inline editable field (optional toggle behavior later via JS) -->
                  <input type="text"
                        class="rename-input hidden w-full px-2 py-1 text-sm rounded bg-gray-100 dark:bg-gray-700"
                        value="{{ convo.name }}" data-original="{{ convo.name }}" />

                  <!-- Export Options -->
                  <div class="flex items-center gap-2 mt-1 ml-1">
                    <a href="/export_session/{{ convo.name }}.pdf"
                      class="p-1.5 rounded bg-gray-200 dark:bg-gray-700 hover:bg-primary hover:text-white transition"
                      title="Export as PDF">
                      <i data-lucide="file-text" class="w-4 h-4"></i>
                    </a>
                    <a href="/export_session/{{ convo.name }}.md"
                      class="p-1.5 rounded bg-gray-200 dark:bg-gray-700 hover:bg-green-500 hover:text-white transition"
                      title="Export as Markdown">
                      <i data-lucide="code" class="w-4 h-4"></i>
                    </a>
                    <!-- Delete -->
                    <form action="/chat/delete_session/{{ convo.id }}" method="post"
                      onsubmit="return confirm('Delete this conversation permanently?')" class="inline">
                      <button type="submit"
                        class="p-1.5 rounded bg-gray-200 dark:bg-gray-700 hover:bg-danger hover:text-white transition"
                        title="Delete Conversation">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                      </button>
                    </form>

                  </div>
                </div>
              {% endfor %}
            </div>
          </details>
        {% else %}
          <span class="ml-4 text-muted-foreground text-sm">No sessions</span>
        {% endif %}
      </div>
    </details>

    <!-- Explore Models Dropdown -->
    <h3 class="text-xs uppercase font-semibold tracking-wide text-gray-500 dark:text-gray-400 mb-2">
      Model checkout
    </h3>
    <details class="group mt-2">
      <summary class="cursor-pointer flex items-center gap-2 hover:text-primary">
        <i data-lucide="cpu" class="w-5 h-5"></i> Explore Models
      </summary>
      <div class="ml-6 mt-1 space-y-1">
        {% for model_name in models.keys() %}
          <a href="/chat/model/{{ model_name }}" class="block hover:text-primary">{{ model_name }}</a>
        {% endfor %}
      </div>
    </details>
    <!-- Explore Expert Models Dropdown -->
    <h3 class="text-xs uppercase font-semibold tracking-wide text-gray-500 dark:text-gray-400 mb-2">
      Expert Models
    </h3>
    <details class="group mt-2">
      <summary class="cursor-pointer flex items-center gap-2 hover:text-primary">
        <i data-lucide="star" class="w-5 h-5"></i> Explore Expert Models
      </summary>
      <div class="ml-6 mt-1 space-y-1">
        {% for model_name in models.keys() %}
          <a href="/chat/model/{{ model_name }}" class="block hover:text-primary">{{ model_name }}</a>
        {% endfor %}
      </div>
    </details>
    <!-- Cloud Management -->
    <h3 class="text-xs uppercase font-semibold tracking-wide text-gray-500 dark:text-gray-400 mb-2">
      Cloud
    </h3>
    <details class="group mt-2">
      <summary class="cursor-pointer flex items-center gap-2 hover:text-primary">
        <i data-lucide="Cloud" class="w-5 h-5"></i> Cloud Management
      </summary>
      <div class="ml-6 mt-1 space-y-1">
        {% for model_name in models.keys() %}
          <a href="/chat/model/{{ model_name }}" class="block hover:text-primary">{{ model_name }}</a>
        {% endfor %}
      </div>
    </details>
    
  </div>
</aside>

<!-- Mini Ribbon Sidebar -->
<aside id="sidebar-ribbon"
  class="fixed top-[56px] left-0 bottom-0 w-12 bg-gray-100 dark:bg-gray-800 border-r overflow-y-auto
         transition-transform duration-300 z-30 flex-col items-center py-4
         text-gray-600 dark:text-gray-300 hidden">

  <div class="flex flex-col items-center space-y-6 sm:space-y-8 md:space-y-10">
    <a href="/" title="Dashboard" class="hover:text-primary">
      <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
    </a>
    <a href="/projects" title="Projects" class="hover:text-primary">
      <i data-lucide="flask-conical" class="w-5 h-5"></i>
    </a>
    <a href="/settings" title="Settings" class="hover:text-primary">
      <i data-lucide="settings" class="w-5 h-5"></i>
    </a>
    <a href="/chat" title="Conversation" class="hover:text-primary">
      <i data-lucide="message-square" class="w-5 h-5"></i>
    </a>
    <!--Here need to add & modify route targets for only minimied left side pane -->
    <a href="/chat/explore" title="Explore Models" class="hover:text-primary">
      <i data-lucide="cpu" class="w-5 h-5"></i>
    </a>
    <a href="/chat/explore" title="Explore Expert Models" class="hover:text-primary">
      <i data-lucide="star" class="w-5 h-5"></i>
    </a>
    <a href="/chat/explore" title="Cloud Explorer" class="hover:text-primary">
      <i data-lucide="Cloud" class="w-5 h-5"></i>
    </a>
    <a href="/chat/explore" title="Big function" class="hover:text-primary">
      <i data-lucide="Rocket" class="w-5 h-5"></i>
    </a>
  </div>

</aside>

    <!-- Main Content Area -->
    <main id="main-content"
          class="ml-64 flex-1 px-4 py-6 pb-20 transition-all duration-300 overflow-y-auto">
      {% block content %}{% endblock %}
    </main>
  </div>

  <!-- Scripts -->
  <script>
    const UI_KEYS = {
      leftCollapsed: "ui:leftCollapsed",
    };

    function setFlag(key, val) {
      localStorage.setItem(key, val ? "1" : "0");
    }

    function getFlag(key, def = false) {
      const v = localStorage.getItem(key);
      return v === null ? def : v === "1";
    }

    function applyLeftSidebarState() {
      const collapsed = getFlag(UI_KEYS.leftCollapsed, false);
      const sidebar = document.getElementById('sidebar');
      const ribbon = document.getElementById('sidebar-ribbon');
      const main = document.getElementById('main-content');

      if (collapsed) {
        sidebar.classList.add('hidden');
        ribbon.classList.remove('hidden');
        main.classList.remove('ml-64');
        main.classList.add('ml-12');
      } else {
        sidebar.classList.remove('hidden');
        ribbon.classList.add('hidden');
        main.classList.remove('ml-12');
        main.classList.add('ml-64');
      }
    }

    function toggleSidebar() {
      const collapsed = !getFlag(UI_KEYS.leftCollapsed, false);
      setFlag(UI_KEYS.leftCollapsed, collapsed);
      applyLeftSidebarState();
    }

    // document.addEventListener('DOMContentLoaded', applyLeftSidebarState);
    document.addEventListener('DOMContentLoaded', () => {
      applyLeftSidebarState();
      lucide.createIcons();  // Move into DOMContentLoaded if needed
      });

    function toggleTheme() {
      const html = document.documentElement;
      const isDark = html.classList.toggle("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    // Context import feedback
    if (new URLSearchParams(window.location.search).get("imported") === "true") {
      alert("‚úÖ Context imported successfully!");
    }

    document.getElementById("save-system-prompt")?.addEventListener("click", () => {
    const prompt = document.getElementById("system-prompt").value;
    fetch("/save_system_prompt", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt }),
    }).then(res => res.json()).then(data => {
      alert("System prompt saved.");
    });
  });
  document.querySelectorAll('.rename-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const container = btn.closest('.group');
      const input = container.querySelector('.rename-input');
      const link = container.querySelector('a');
      input.classList.toggle('hidden');
      if (!input.classList.contains('hidden')) {
        input.focus();
      }
    });
  });

  // Optional: Save on Enter key
  document.querySelectorAll('.rename-input').forEach(input => {
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        const newName = input.value.trim();
        const original = input.dataset.original;
        if (newName && newName !== original) {
          // TODO: Add rename request to server here
          alert(`Rename "${original}" to "${newName}"`);
        }
        input.classList.add('hidden');
      }
    });
  });
  </script>

  {% block script_extra %}{% endblock %}
  <!--script>
    lucide.createIcons();
  </script-->
  <style>
    body {
      font-family: 'Inter', sans-serif;
      font-size: 15px;
      line-height: 1.6;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background-color: rgba(120, 120, 120, 0.3);
      border-radius: 4px;
    }

    .dark .shadow-sm {
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
    }
  </style>
</body>
</html>
