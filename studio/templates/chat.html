{% extends "base.html" %}
{% block title %}{{ agent | capitalize }} Chat{% endblock %}

{% block content %}
{% if not request.session.get('user_id') %}
  <div class="flex flex-col items-center justify-center text-center p-10">
    <h2 class="text-xl font-semibold mb-2">Welcome to KUCHU_AI Studio</h2>
    <p class="mb-4">You are in guest mode. Login or register to save your chats.</p>
    <div class="space-x-4">
      <a href="/auth/login" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Login</a>
      <a href="/auth/register" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-black dark:text-white rounded hover:bg-gray-400">Register</a>
    </div>
  </div>
{% endif %}

<!-- MAIN CHAT AREA (full-width with comfy gutters) -->
<div id="mainContent"
     class="w-full max-w-full px-3 sm:px-5 md:px-8 lg:px-10 pb-36 transition-all duration-200 overflow-y-auto">

  {% if conversation %}
    {% for entry in conversation %}

      <!-- USER MESSAGE -->
      {% if entry.role == "user" %}
      <div class="chat-row chat-row-user flex justify-end mb-4">
        <div class="max-w-[95%] md:max-w-[78%] lg:max-w-[72%]">
          <div class="flex items-center justify-end gap-2 mb-1">
            <time class="text-[11px] text-gray-400">{{ entry.ts or '' }}</time>
            <div class="flex items-center gap-2">
              <span class="sr-only">User</span>
              <div class="w-8 h-8 rounded-full bg-blue-500 text-white grid place-items-center text-xs font-semibold">You</div>
            </div>
          </div>
          <div
            class="bubble bubble-user animate-in-right bg-gradient-to-br from-blue-600 to-blue-500 text-white rounded-2xl shadow-lg
                   px-4 py-3 leading-relaxed text-[15px]">
            <div class="whitespace-pre-wrap">{{ entry.content | e }}</div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- ASSISTANT MESSAGE -->
      {% if entry.role == "assistant" %}
      <div class="chat-row chat-row-ai flex justify-start mb-4">
        <div class="max-w-[95%] md:max-w-[78%] lg:max-w-[72%]">
          <div class="flex items-center justify-start gap-2 mb-1">
            <div class="flex items-center gap-2">
              <span class="sr-only">Assistant</span>
              <div class="w-8 h-8 rounded-full bg-emerald-600 text-white grid place-items-center text-xs font-semibold">AI</div>
              <div class="text-[11px] text-gray-500">{{ agent | default('AI') }}</div>
            </div>
            <time class="text-[11px] text-gray-400">{{ entry.ts or '' }}</time>
          </div>

          <div
            class="bubble bubble-ai animate-in-left bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100
                   rounded-2xl shadow border border-gray-100 dark:border-gray-700 px-4 py-3 leading-relaxed text-[15px]">
            <div class="prose prose-sm dark:prose-invert max-w-none whitespace-pre-wrap">{{ entry.content | e }}</div>
          </div>

          <!-- QUICK ACTIONS -->
          <div class="mt-2 flex flex-wrap gap-1.5 text-xs">
            <button class="btn-like quick-btn">ğŸ‘</button>
            <button class="btn-dislike quick-btn">ğŸ‘</button>
            <button class="btn-regenerate quick-btn">â†º Regenerate</button>
            <button class="btn-md quick-btn">ğŸ“„ MD</button>
            <button class="btn-doc quick-btn">ğŸ“ Doc</button>
            <button class="btn-edit quick-btn">âœï¸ Edit</button>
            <button class="btn-save quick-btn">ğŸ’¾ Save</button>
            <button class="btn-del quick-btn">ğŸ—‘ï¸ Delete</button>
            <button class="btn-pin quick-btn">ğŸ“Œ Context</button>
            <button class="copy-btn quick-btn">ğŸ“‹ <span class="hidden sm:inline">Copy</span></button>
          </div>
        </div>
      </div>
      {% endif %}

    {% endfor %}
  {% else %}
    <div class="text-center text-gray-500 py-12">No messages yet â€” say hi ğŸ‘‹</div>
  {% endif %}
</div>

<!-- COMPOSER -->
<form id="chatForm"
      method="post"
      action="/chat/model/{{ agent }}/send"
      class="fixed bottom-0 left-0 right-0 md:left-64 bg-white/90 dark:bg-gray-900/90 backdrop-blur
             px-3 sm:px-5 md:px-8 lg:px-10 py-3 sm:py-4 border-t border-gray-200 dark:border-gray-700 z-50">

  {% if conversation_id %}
    <input type="hidden" name="conversation_id" value="{{ conversation_id }}">
  {% endif %}
  {% if not conversation_id %}
    <input type="text" name="conversation_name" placeholder="Name this conversation..." required
           class="mb-2 px-4 py-2 w-64 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm
                  text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" />
  {% else %}
    <input type="hidden" name="conversation_name" value="{{ conversations|length > 0 and conversations[-1].name or '' }}">
  {% endif %}

  <div class="flex gap-2">
    <textarea name="user_input" id="user_input" rows="1" placeholder="Send a messageâ€¦"
              required
              class="flex-1 px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900
                     text-sm text-gray-800 dark:text-gray-100 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500
                     transition-[height] duration-150 will-change-auto"></textarea>

    <button id="sendBtn" type="submit"
            class="px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 active:translate-y-[1px]
                   flex items-center gap-2 transition">
      <span class="text-lg">â¤</span>
      <span id="sendSpinner" class="hidden animate-spin text-sm">â³</span>
    </button>
  </div>
</form>

<!-- RIGHT SIDEBAR -->
<aside id="rightSidebar"
  class="fixed top-[56px] right-0 bottom-0 w-64 bg-white dark:bg-gray-900 shadow-lg border-l border-gray-200 dark:border-gray-800
         p-4 flex flex-col gap-4 transition-transform duration-300 transform translate-x-full z-40">
  <button id="toggleRightSidebarBtn"
          class="absolute -left-8 top-1/2 -translate-y-1/2 bg-gray-700 text-white rounded-l px-2 py-1 text-sm hover:bg-gray-800"
          aria-label="Toggle studio configuration panel">
    Â«
  </button>

  <h1 class="text-sm tracking-wide uppercase font-semibold text-gray-500 dark:text-gray-400">Studio Configuration</h1>

  <h3 class="text-xs font-semibold text-gray-800 dark:text-white">Tools</h3>
  <div class="flex items-center gap-2">
    <form method="POST" action="/tools/context_manager/context/import" enctype="multipart/form-data">
      <label class="cursor-pointer px-2 py-1 text-sm bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600
                    text-gray-800 dark:text-gray-100 rounded shadow">
        ğŸ“¥
        <input type="file" name="file" accept=".json" class="hidden" onchange="this.form.submit()">
      </label>
    </form>
    <a href="/tools/context_manager/context/export"
       class="px-2 py-1 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded shadow">ğŸ“¤</a>
  </div>

  <h3 class="text-xs uppercase font-semibold tracking-wide text-gray-500 dark:text-gray-400">Creativity â€” Temperature</h3>
  <div class="flex items-center gap-2">
    <input type="range" id="temperature-slider" min="0" max="1" step="0.01" value="{{ temperature|default(0.7) }}">
    <span id="temp-value" class="text-xs">{{ temperature|default(0.7) }}</span>
  </div>

  <h3 class="text-xs uppercase font-semibold tracking-wide text-gray-500 dark:text-gray-400">Edit Prompt</h3>
  <div class="flex flex-col gap-2">
    <label for="system-prompt" class="text-xs text-gray-500 dark:text-gray-400">System Prompt</label>
    <textarea id="system-prompt" rows="6"
              class="px-2 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-xs
                     text-gray-800 dark:text-gray-100">{{ system_prompt|default("You are a helpful assistant.") }}</textarea>
    <button id="save-system-prompt"
            class="px-3 py-1.5 bg-gray-200 dark:bg-gray-700 rounded text-xs hover:bg-gray-300 dark:hover:bg-gray-600 w-fit">
      Save
    </button>
  </div>
</aside>
<div id="sidebarBackdrop" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

<style>
  :root {
    --header-h: 56px;
    --sidebar-w: 16rem;
    --transition-dur: .3s;
  }

  /* Content spacing & scrolling */
  #mainContent { padding-top: calc(var(--header-h) + .5rem); scroll-padding-top: var(--header-h); }

  /* Quick action buttons (shared) */
  .quick-btn {
    padding: .35rem .6rem;
    border-radius: .6rem;
    background: transparent;
    transition: background .15s ease;
  }
  .quick-btn:hover { background: rgba(59,130,246,.10); }

  /* Message bubbles */
  .bubble { position: relative; word-wrap: break-word; }
  .bubble-user { border-top-right-radius: .4rem; }
  .bubble-ai   { border-top-left-radius: .4rem; }

  /* Animations */
  @keyframes slideFadeLeft {
    from { opacity: 0; transform: translateX(-12px) translateY(4px); }
    to   { opacity: 1; transform: translateX(0) translateY(0); }
  }
  @keyframes slideFadeRight {
    from { opacity: 0; transform: translateX(12px) translateY(4px); }
    to   { opacity: 1; transform: translateX(0) translateY(0); }
  }
  .animate-in-left  { animation: slideFadeLeft .28s ease-out both; }
  .animate-in-right { animation: slideFadeRight .28s ease-out both; }

  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .animate-in-left, .animate-in-right { animation: none !important; }
    * { scroll-behavior: auto !important; }
  }

  /* Desktop push when right sidebar is open */
  @media (min-width: 768px) {
    .right-open #mainContent { margin-right: var(--sidebar-w); }
    .right-open #chatForm   { right: var(--sidebar-w); }
  }
</style>
{% endblock %}

{% block script_extra %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ---- THEME ----
  if (localStorage.getItem("theme") === "dark") document.documentElement.classList.add("dark");

  // ---- DOM HOOKS ----
  const chatForm    = document.getElementById("chatForm");
  const userInput   = document.getElementById("user_input");
  const mainContent = document.getElementById("mainContent");
  const sendSpinner = document.getElementById("sendSpinner");
  const rightBar    = document.getElementById("rightSidebar");
  const rightBtn    = document.getElementById("toggleRightSidebarBtn");
  const backdrop    = document.getElementById("sidebarBackdrop");

  // ---- RIGHT SIDEBAR STATE ----
  const RIGHT_KEY = "ui:rightCollapsed";
  const getFlag = (k, d=true) => (localStorage.getItem(k) ?? (d ? "1":"0")) === "1";
  const setFlag = (k, v) => localStorage.setItem(k, v ? "1":"0");

  function applySidebarState() {
    const isRightCollapsed = getFlag(RIGHT_KEY, true);
    const isMobile = window.innerWidth < 768;

    if (isRightCollapsed) {
      rightBar.classList.add("translate-x-full");
      document.body.classList.remove("right-open");
      rightBtn.textContent = "Â«";
    } else {
      rightBar.classList.remove("translate-x-full");
      document.body.classList.add("right-open");
      rightBtn.textContent = "Â»";
    }

    if (isMobile) {
      mainContent.style.marginRight = '0';
      chatForm.style.right = '0';
      backdrop.classList.toggle('hidden', isRightCollapsed);
    } else {
      backdrop.classList.add('hidden');
    }
  }

  rightBtn?.addEventListener("click", () => {
    setFlag(RIGHT_KEY, !getFlag(RIGHT_KEY, true));
    applySidebarState();
  });
  backdrop?.addEventListener("click", () => { setFlag(RIGHT_KEY, true); applySidebarState(); });
  window.addEventListener("resize", applySidebarState);
  applySidebarState();

  // ---- ENTER TO SEND ----
  userInput?.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      chatForm?.dispatchEvent(new Event("submit", { cancelable: true }));
    }
  });

  // ---- AUTO-RESIZE INPUT ----
  const capPx = 192; // 12rem
  function autoSize(el) {
    el.style.height = "auto";
    el.style.height = Math.min(el.scrollHeight, capPx) + "px";
  }
  userInput && (userInput.addEventListener("input", () => autoSize(userInput)),
                userInput.addEventListener("blur", () => { if (!userInput.value.trim()) userInput.style.height = "2.5rem"; }),
                autoSize(userInput));

  // ---- AJAX SUBMIT ----
  chatForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const userText = (userInput.value || '').trim();
    if (!userText) return;

    appendUserBubble(userText);
    userInput.value = '';
    autoSize(userInput);
    adjustBottomPadding();
    scrollToBottom();
    sendSpinner.classList.remove('hidden');

    const formData = new FormData(chatForm);
    formData.set('user_input', userText);
    const url = chatForm.getAttribute("action");

    try {
      const res = await fetch(url, { method: "POST", body: formData });
      const data = await res.json();
      appendAIBubble(data.ai || "No response");
      wireCopyButtons();
      wireActionButtons();
      formatTripleBackticks();
      Prism.highlightAll();
      scrollToBottom();

      if (data.conversation_id) {
        let hidden = chatForm.querySelector('input[name="conversation_id"]');
        if (!hidden) {
          hidden = document.createElement("input");
          hidden.type = "hidden";
          hidden.name = "conversation_id";
          chatForm.appendChild(hidden);
        }
        hidden.value = data.conversation_id;
      }
    } catch (err) {
      console.error(err);
      appendAIBubble("Error contacting model.");
      scrollToBottom();
    } finally {
      sendSpinner.classList.add('hidden');
    }
  });

  // ---- RENDER HELPERS ----
  function esc(s) {
    if (s === null || s === undefined) return '';
    return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function appendUserBubble(text) {
    const ts = new Date().toLocaleTimeString();
    const html = `
      <div class="chat-row chat-row-user flex justify-end mb-4 will-change-transform">
        <div class="max-w-[95%] md:max-w-[78%] lg:max-w-[72%]">
          <div class="flex items-center justify-end gap-2 mb-1">
            <time class="text-[11px] text-gray-400">${ts}</time>
            <div class="w-8 h-8 rounded-full bg-blue-500 text-white grid place-items-center text-xs font-semibold">You</div>
          </div>
          <div class="bubble bubble-user animate-in-right bg-gradient-to-br from-blue-600 to-blue-500 text-white rounded-2xl shadow-lg px-4 py-3 text-[15px]">
            <div class="whitespace-pre-wrap">${esc(text)}</div>
          </div>
        </div>
      </div>`;
    mainContent.insertAdjacentHTML('beforeend', html);
  }

  function appendAIBubble(aiText) {
    const ts = new Date().toLocaleTimeString();
    const html = `
      <div class="chat-row chat-row-ai flex justify-start mb-4 will-change-transform">
        <div class="max-w-[95%] md:max-w-[78%] lg:max-w-[72%]">
          <div class="flex items-center justify-start gap-2 mb-1">
            <div class="w-8 h-8 rounded-full bg-emerald-600 text-white grid place-items-center text-xs font-semibold">AI</div>
            <div class="text-[11px] text-gray-500">{{ agent | default('AI') }}</div>
            <time class="text-[11px] text-gray-400">${ts}</time>
          </div>
          <div class="ai-msg bubble bubble-ai animate-in-left bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-2xl shadow border border-gray-100 dark:border-gray-700 px-4 py-3 text-[15px]">
            <div class="content whitespace-pre-wrap">${esc(aiText)}</div>
          </div>
          <div class="mt-2 flex flex-wrap gap-1.5 text-xs">
            <button class="btn-like quick-btn">ğŸ‘</button>
            <button class="btn-dislike quick-btn">ğŸ‘</button>
            <button class="btn-regenerate quick-btn">â†º Regenerate</button>
            <button class="btn-md quick-btn">ğŸ“„ MD</button>
            <button class="btn-doc quick-btn">ğŸ“ Doc</button>
            <button class="btn-edit quick-btn">âœï¸ Edit</button>
            <button class="btn-save quick-btn">ğŸ’¾ Save</button>
            <button class="btn-del quick-btn">ğŸ—‘ï¸ Delete</button>
            <button class="btn-pin quick-btn">ğŸ“Œ Context</button>
            <button class="copy-btn quick-btn" data-content="${esc(aiText)}">ğŸ“‹ <span class="hidden sm:inline">Copy</span></button>
          </div>
        </div>
      </div>`;
    mainContent.insertAdjacentHTML('beforeend', html);
  }

  // ---- CODE FENCE FORMATTER ----
  function formatTripleBackticks() {
    const blocks = document.querySelectorAll(".ai-msg .content");
    const fence  = /```(\w+)?\n([\s\S]*?)```/g;
    blocks.forEach(node => {
      const original = node.textContent || '';
      if (!original.includes("```")) return;
      let last = 0, html = "", m;
      while ((m = fence.exec(original)) !== null) {
        html += esc(original.slice(last, m.index)).replace(/\n/g, "<br/>");
        html += `
        <div class="relative bg-gray-900 text-white text-sm rounded-xl overflow-x-auto my-3 p-4 font-mono">
          <button class="absolute top-2 right-2 text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded copy-btn" data-content="${esc(m[2])}">
            Copy
          </button>
          <pre class="m-0"><code class="language-${m[1] || 'plaintext'}">${esc(m[2])}</code></pre>
        </div>`;
        last = fence.lastIndex;
      }
      html += esc(original.slice(last)).replace(/\n/g, "<br/>");
      node.innerHTML = html;
    });
  }

  // ---- COPY & ACTION BUTTONS ----
  function wireCopyButtons() {
    document.querySelectorAll('.copy-btn').forEach(btn => {
      if (btn.dataset.wired) return;
      btn.dataset.wired = '1';
      btn.addEventListener('click', () => {
        const text = btn.dataset.content || btn.closest('.ai-msg')?.innerText || '';
        navigator.clipboard?.writeText(text).then(
          () => { btn.textContent = 'Copied'; setTimeout(()=>btn.innerHTML='ğŸ“‹ <span class="hidden sm:inline">Copy</span>', 900); },
          () => { btn.innerHTML = 'ğŸ“‹ <span class="hidden sm:inline">Copy</span>'; }
        );
      });
    });
  }
  function wireActionButtons() {
    document.querySelectorAll('.btn-regenerate').forEach(btn => {
      if (btn.dataset.wired) return;
      btn.dataset.wired = '1';
      btn.addEventListener('click', () => { btn.textContent = 'â†º'; /* hook your regenerate flow here */ });
    });
  }

  // ---- KEEP SPACE FOR COMPOSER ----
  function adjustBottomPadding() {
    const h = chatForm ? chatForm.offsetHeight + 16 : 16;
    mainContent.style.paddingBottom = `${h}px`;
  }
  adjustBottomPadding();
  window.addEventListener("resize", adjustBottomPadding);

  // ---- INITIALIZE EXISTING CONTENT ----
  formatTripleBackticks();
  wireCopyButtons();
  wireActionButtons();
  Prism.highlightAll();
  scrollToBottom();

  function scrollToBottom() {
    mainContent.scrollTop = mainContent.scrollHeight;
  }

  // Temperature UI
  document.getElementById("temperature-slider")?.addEventListener("input", (e) => {
    document.getElementById("temp-value").innerText = e.target.value;
  });
});
</script>
{% endblock %}
