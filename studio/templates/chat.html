{% extends "base.html" %}
{% block title %}{{ agent | capitalize }} Chat{% endblock %}

{% block content %}
{% if not request.session.get('user_id') %}
  <div class="flex flex-col items-center justify-center text-center p-10">
    <h2 class="text-xl font-semibold mb-2">Welcome to KUCHU_AI Studio</h2>
    <p class="mb-4">You are in guest mode. Login or register to save your chats.</p>
    <div class="space-x-4">
      <a href="/auth/login" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Login</a>
      <a href="/auth/register" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-black dark:text-white rounded hover:bg-gray-400">Register</a>
    </div>
  </div>
{% endif %}

<!-- MAIN CHAT AREA -->
<div id="mainContent" class="ml-64 mr-16 pb-32 transition-all duration-200 overflow-y-auto">
  {% if conversation %}
  {% for entry in conversation %}
    <!-- USER BUBBLE -->
    {% if entry.role == "user" %}
    <div class="flex items-start gap-3 mb-4">
      <div class="flex-1">
        <div class="flex items-center justify-between mb-1">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-medium transition-transform hover:scale-[1.01]">You</div>
            <div class="text-xs text-gray-500">You</div>
          </div>
          <div class="text-xs text-gray-400">{{ entry.ts or '' }}</div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border-l-4 border-blue-500">
          <div class="whitespace-pre-wrap leading-relaxed text-sm">{{ entry.content | e }}</div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- AI BUBBLE -->
    {% if entry.role == "assistant" %}
    <div class="flex items-start gap-3 mb-4">
      <div class="flex-1">
        <div class="flex items-center justify-between mb-1">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center text-sm font-medium transition-transform hover:scale-[1.01]">AI</div>
            <div class="text-xs text-gray-500">{{ agent | default('AI') }}</div>
          </div>
          <div class="flex items-center gap-2">
            <div class="text-xs text-gray-400">{{ entry.ts or '' }}</div>
            <button class="copy-btn text-xs px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-gray-700 dark:text-gray-200" data-content="{{ entry.content | e }}">Copy</button>
          </div>
        </div>
        <div class="ai-msg bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow border-l-4 border-green-500">
          <div class="mt-2 whitespace-pre-wrap leading-relaxed text-sm">{{ entry.content | e }}</div>
        </div>

        <!-- quick actions -->
        <div class="mt-2 flex gap-2 text-sm">
          <button class="btn-like px-2 py-1 bg-transparent rounded hover:bg-gray-200 dark:hover:bg-gray-600">👍</button>
          <button class="btn-dislike px-2 py-1 bg-transparent rounded hover:bg-gray-200 dark:hover:bg-gray-600">👎</button>
          <button class="btn-regenerate text-xs px-2 py-1 bg-transparent rounded hover:bg-gray-200 dark:hover:bg-gray-600">↺ Regenerate</button>
          <button class="btn-regenerate text-xs px-2 py-1 bg-transparent rounded hover:bg-gray-200 dark:hover:bg-gray-600">📄 MD Conversion</button>
          <button class="btn-regenerate text-xs px-2 py-1 bg-transparent rounded hover:bg-gray-200 dark:hover:bg-gray-600">📝 Doc Conversion</button>
          <button class="btn-regenerate text-xs px-2 py-1 bg-transparent rounded hover:bg-gray-200 dark:hover:bg-gray-600">✏️ Edit as Query</button>
          <button class="btn-regenerate text-xs px-2 py-1 bg-transparent rounded hover:bg-gray-200 dark:hover:bg-gray-600">💾 Save for later</button>
          <button class="btn-regenerate text-xs px-2 py-1 bg-transparent rounded hover:bg-gray-200 dark:hover:bg-gray-600">🗑️ Delete</button>
          <button class="btn-regenerate text-xs px-2 py-1 bg-transparent rounded hover:bg-gray-200 dark:hover:bg-gray-600">📌 Grab into context</button>
          <button class="btn-regenerate text-xs px-2 py-1 bg-transparent rounded hover:bg-gray-200 dark:hover:bg-gray-600">|||</button>
        </div>
      </div>
    </div>
    {% endif %}
  {% endfor %}
{% else %}
  <div class="text-center text-gray-500 py-12">No messages yet — say hi 👋</div>
{% endif %}
</div>
<form id="chatForm"
      method="post"
      action="/chat/model/{{ agent }}/send"
      class="fixed bottom-0 left-64 right-16 bg-white dark:bg-gray-800 p-4 flex gap-3 border-t border-gray-200 dark:border-gray-700 z-50 transition-all duration-200">

  <!-- Hidden conversation id if present -->
  {% if conversation_id %}
    <input type="hidden" name="conversation_id" value="{{ conversation_id }}">
  {% endif %}

  <!-- Conversation name only when creating new -->
  {% if not conversation_id %}
    <input type="text"
           name="conversation_name"
           placeholder="Name this conversation..."
           required
           class="px-4 py-2 w-48 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-sm text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" />
  {% else %}
    <input type="hidden" name="conversation_name" value="{{ conversations|length > 0 and conversations[-1].name or '' }}">
  {% endif %}


  <textarea name="user_input"
            id="user_input"
            rows="2"
            placeholder="Send a message..."
            required
            class="px-4 py-2 flex-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-sm text-gray-800 dark:text-gray-100 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-150"></textarea>

  <button id="sendBtn"
          type="submit"
          class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2 transition-colors duration-200">
    <span class="text-xl">➤</span>
    <span id="sendSpinner" class="hidden animate-spin text-sm">⏳</span>
  </button>
</form>

<!-- RIGHT SIDEBAR -->
<aside id="rightSidebar"
       class="fixed top-[56px] right-0 bottom-0 w-64 bg-white dark:bg-gray-900 shadow-lg border-l border-gray-300 dark:border-gray-700 p-4 flex flex-col gap-4 transition-transform duration-300 transform translate-x-0 z-40">
  <button id="toggleRightSidebarBtn"
        class="absolute -left-8 top-1/2 -translate-y-1/2 bg-gray-700 text-white rounded-l px-2 py-1 text-sm hover:bg-gray-800">
      «
  </button>

  <h1 class="text-lg uppercase font-semibold tracking-wide text-gray-500 dark:text-gray-400 mb-2">
      Studio Configuration
  </h1>
  <h3 class="text-xs font-semibold text-gray-800 dark:text-white">Tools</h3>

  <div class="flex items-center gap-2">
    <!-- Import -->
    <form method="POST" action="/tools/context_manager/context/import" enctype="multipart/form-data">
      <label class="cursor-pointer px-2 py-1 text-sm bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 rounded shadow">
        📥
        <input type="file" name="file" accept=".json" class="hidden" onchange="this.form.submit()">
      </label>
    </form>

    <!-- Export -->
    <a href="/tools/context_manager/context/export"
       class="px-2 py-1 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded shadow">📤</a>
  </div>
  <!-- Temperature Control -->
  <h3 class="text-xs uppercase font-semibold tracking-wide text-gray-500 dark:text-gray-400 mb-2">
      Creativity - Temparature
  </h3>
  <div class="control-section">
    <label for="temperature-slider">Creativity (Temperature)</label>
    <input type="range" id="temperature-slider" min="0" max="1" step="0.01" value="{{ temperature|default(0.7) }}">
    <span id="temp-value">{{ temperature|default(0.7) }}</span>
  </div>
  <!-- System Prompt Editor -->
  <h3 class="text-xs uppercase font-semibold tracking-wide text-gray-500 dark:text-gray-400 mb-2">
      Edit Prompt
  </h3>
  <div class="control-section">
    <label for="system-prompt">System Prompt</label>
    <textarea id="system-prompt" rows="6">{{ system_prompt|default("You are a helpful assistant.") }}</textarea>
    <button id="save-system-prompt">Save</button>
  </div>
</aside>
<style>
  :root {
    --header-h: 56px;               /* Height of the fixed header */
    --sidebar-w: 16rem;             /* Width of sidebar when expanded */
    --transition-dur: 0.3s;
  }

  /* Main content layout fix under sticky header */
  #mainContent {
    padding-top: calc(var(--header-h) + 0.75rem);
    scroll-padding-top: var(--header-h);
    transition: width var(--transition-dur) ease;
  }

  /* Remove unintentional spacing on first child */
  #mainContent > *:first-child {
    margin-top: 0 !important;
    padding-top: 0 !important;
  }

  /* Prevent empty flex containers from affecting layout */
  body > .flex:empty {
    display: none !important;
    height: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* Sidebar collapse behavior */
  #mainContent.right-collapsed {
    width: calc(100% - var(--sidebar-w));
  }

  /* Modern fade-in on hover */
  .group-hover\:flex {
    transition: opacity 0.2s ease, transform 0.2s ease;
    opacity: 0;
    transform: translateY(2px);
  }

  .group:hover .group-hover\:flex {
    opacity: 1;
    transform: translateY(0);
  }

  /* Optional: Smooth shadow under header (gives crisp feel) */
  header {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    z-index: 10;
  }

  /* Optional: Slight polish for buttons (modern flat style) */
  button {
    transition: background 0.2s ease, color 0.2s ease;
  }

  button:hover {
    background-color: #f3f4f6;
    color: #111827;
  }

  .input-container {
  display: flex;
  align-items: flex-end;
  padding: 0.5rem;
  border-top: 1px solid #ccc;
  background: #fff;
  position: sticky;
  bottom: 0;
}

  #userInput:focus {
    outline: none;
    background: #fff;
  }

  #send-button {
    margin-left: 0.5rem;
    padding: 0.5rem 1rem;
    background: #3f83f8;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
  }

  #send-button:hover {
    background: #2f6fe4;
  }
  #userinput {
    height: auto;
    min-height: 2.5rem;
    max-height: 12rem;
    overflow-y: hidden;
    resize: none;
    line-height: 1.4;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    transition: height 0.2s ease;
    box-sizing: border-box;
  }
</style>
{% endblock %}

{% block script_extra %}
<!-- PrismJS for Syntax Highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // ---- THEME ----
  if (localStorage.getItem("theme") === "dark") {
    document.documentElement.classList.add("dark");
  }

  // ---- DOM HOOKS ----
  const chatForm   = document.getElementById("chatForm");
  const userInput  = document.getElementById("user_input");
  const mainContent= document.getElementById("mainContent");
  const sendSpinner= document.getElementById("sendSpinner");
  const rightBar   = document.getElementById("rightSidebar");
  const rightBtn   = document.getElementById("toggleRightSidebarBtn");

  // ---- SMALL LOCAL HELPERS ----
  const RIGHT_KEY = "ui:rightCollapsed";
  const getFlag = (k, d=false) => (localStorage.getItem(k) ?? (d ? "1":"0")) === "1";
  const setFlag = (k, v) => localStorage.setItem(k, v ? "1" : "0");

  // ---- ENTER TO SEND ----
  if (userInput) {
    userInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        chatForm?.dispatchEvent(new Event("submit", { cancelable: true }));
      }
    });
  }

  // ---- AJAX SUBMIT ----
  if (chatForm) {
  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const userText = (userInput.value || '').trim();
    if (!userText) return;

    appendUserBubble(userText);
    userInput.value = '';
    adjustBottomPadding();
    scrollToBottom();
    sendSpinner.classList.remove('hidden');

    const formData = new FormData(chatForm);
    formData.set('user_input', userText);  // always ensure this is set

    // conversation_id is already in the form as hidden input
    const url = chatForm.getAttribute("action");

    try {
      const res = await fetch(url, { method: "POST", body: formData });
      const data = await res.json();

      appendAIBubble(data.ai || "No response");
      wireCopyButtons();
      wireActionButtons();
      formatTripleBackticks();
      scrollToBottom();

      // If backend returns conversation_id (for new convos), inject into form
      if (data.conversation_id) {
        let hidden = chatForm.querySelector('input[name="conversation_id"]');
        if (!hidden) {
          hidden = document.createElement("input");
          hidden.type = "hidden";
          hidden.name = "conversation_id";
          chatForm.appendChild(hidden);
        }
        hidden.value = data.conversation_id;
      }

    } catch (err) {
      console.error(err);
      appendAIBubble("Error contacting model.");
      scrollToBottom();
    } finally {
      sendSpinner.classList.add('hidden');
    }
  });
}


  function appendUserBubble(text) {
    const ts = new Date().toLocaleTimeString();
    const html = `
      <div class="flex items-start gap-3 mb-4">
        <div class="flex-1">
          <div class="flex items-center justify-between mb-1">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-medium">You</div>
              <div class="text-xs text-gray-500">You</div>
            </div>
            <div class="text-xs text-gray-400">${ts}</div>
          </div>
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border-l-4 border-blue-500">
            <div class="whitespace-pre-wrap leading-relaxed">${escapeHtml(text)}</div>
          </div>
        </div>
      </div>`;
    mainContent.insertAdjacentHTML('beforeend', html);
  }

  function appendAIBubble(aiText) {
    const ts = new Date().toLocaleTimeString();
    const html = `
      <div class="flex items-start gap-3 mb-4">
        <div class="flex-1">
          <div class="flex items-center justify-between mb-1">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center text-sm font-medium">AI</div>
              <div class="text-xs text-gray-500">{{ agent | default('AI') }}</div>
            </div>
            <div class="flex items-center gap-2">
              <div class="text-xs text-gray-400">${ts}</div>
              <button class="copy-btn text-xs px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-gray-700 dark:text-gray-200" data-content="${escapeHtml(aiText)}">Copy</button>
            </div>
          </div>
          <div class="ai-msg bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow border-l-4 border-green-500">
            <div class="mt-2 whitespace-pre-wrap leading-relaxed">${escapeHtml(aiText)}</div>
          </div>
          <div class="mt-2 flex gap-2 text-sm">
            <button class="btn-like px-2 py-1 bg-transparent rounded hover:bg-gray-200 dark:hover:bg-gray-600">👍</button>
            <button class="btn-dislike px-2 py-1 bg-transparent rounded hover:bg-gray-200 dark:hover:bg-gray-600">👎</button>
            <button class="btn-regenerate px-2 py-1 bg-transparent rounded hover:bg-gray-200 dark:hover:bg-gray-600">↺ Regenerate</button>
          </div>
        </div>
      </div>`;
    mainContent.insertAdjacentHTML('beforeend', html);
  }

  function escapeHtml(s) {
    if (s === null || s === undefined) return '';
    return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function scrollToBottom() {
    mainContent.scrollTop = mainContent.scrollHeight;
  }

  function formatTripleBackticks() {
    const blocks = document.querySelectorAll(".ai-msg > div");
    const fence  = /```(\w+)?\n([\s\S]*?)```/g;
    blocks.forEach(node => {
      const original = node.textContent || '';
      if (!original.includes("```")) return;
      let last = 0, html = "", m;
      while ((m = fence.exec(original)) !== null) {
        html += escapeHtml(original.slice(last, m.index)).replace(/\n/g, "<br/>");
        //html += `<pre class="bg-gray-900 text-gray-100 text-sm p-3 rounded-lg my-3 overflow-x-auto"><code class="block">${escapeHtml(m[2])}</code></pre>`;
        html += `
        <div class="relative bg-gray-900 text-white text-sm rounded-xl overflow-x-auto my-3 p-4 font-mono">
          <button class="absolute top-2 right-2 text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded copy-btn" data-content="${escapeHtml(m[2])}">
            Copy
          </button>
          <pre><code class="language-${m[1] || 'plaintext'}">${escapeHtml(m[2])}</code></pre>
        </div>`;
        last = fence.lastIndex;
      }
      html += escapeHtml(original.slice(last)).replace(/\n/g, "<br/>");
      node.innerHTML = html;
    });
  }

  function wireCopyButtons() {
    document.querySelectorAll('.copy-btn').forEach(btn => {
      if (btn.dataset.wired) return;
      btn.dataset.wired = '1';
      btn.addEventListener('click', () => {
        const text = btn.dataset.content || btn.closest('.ai-msg')?.innerText || '';
        navigator.clipboard?.writeText(text).then(
          () => { btn.textContent = 'Copied'; setTimeout(()=>btn.textContent='Copy', 1000); },
          () => { btn.textContent = 'Copy'; }
        );
      });
    });
  }

  function wireActionButtons() {
    document.querySelectorAll('.btn-regenerate').forEach(btn => {
      if (btn.dataset.wired) return;
      btn.dataset.wired = '1';
      btn.addEventListener('click', () => {
        btn.textContent = '↺';
      });
    });
  }

  // Right sidebar toggle
  function applyRightState() {
    const collapsed = getFlag(RIGHT_KEY, false);
    if (collapsed) {
      rightBar.classList.add("translate-x-full");
      chatForm.classList.replace("right-16", "right-0");
      mainContent.classList.add("right-collapsed");
      rightBtn.textContent = "»";
    } else {
      rightBar.classList.remove("translate-x-full");
      chatForm.classList.replace("right-0", "right-16");
      mainContent.classList.remove("right-collapsed");
      rightBtn.textContent = "«";
    }
  }
  if (rightBtn) {
    rightBtn.addEventListener("click", () => {
      setFlag(RIGHT_KEY, !getFlag(RIGHT_KEY, false));
      applyRightState();
    });
  }
  applyRightState();

  // ---- KEEP SPACE FOR FIXED INPUT ----
  function adjustBottomPadding() {
    const h = chatForm ? chatForm.offsetHeight + 24 : 24;
    mainContent.style.paddingBottom = `${h}px`;
    scrollToBottom();
  }
  adjustBottomPadding();
  window.addEventListener("resize", adjustBottomPadding);

  // initial wiring for any pre-rendered content
  formatTripleBackticks();
  wireCopyButtons();
  wireActionButtons();
  Prism.highlightAll();
});
function resizeInput(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = (textarea.scrollHeight) + 'px';
  }

  // Optional: Reset size when input is empty
  const inputBox = document.getElementById("user_input");

  if (inputBox) {
    inputBox.addEventListener("input", function () {
      this.style.height = "auto";
      this.style.height = Math.min(this.scrollHeight, 192) + "px"; // cap at 12rem
    });

    // Optional: reset height on blur if cleared
    inputBox.addEventListener("blur", function () {
      if (!this.value.trim()) {
        this.style.height = "2.5rem";
      }
    });

    // Initial adjust in case pre-filled
    inputBox.style.height = "auto";
    inputBox.style.height = inputBox.scrollHeight + "px";
    }
    document.getElementById("temperature-slider")?.addEventListener("input", (e) => {
    const tempVal = e.target.value;
    document.getElementById("temp-value").innerText = tempVal;
    // Optionally send via AJAX to store per-session
  });
</script>
{% endblock %}

